!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Neo4jd3=e()}(this,(function(){"use strict";function t(t,e){for(const o of Reflect.ownKeys(e))if("constructor"!==o&&"prototype"!==o&&"name"!==o){const i=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(t,o,i)}}class e{constructor(){}updateNodes(t,e=!1,o=!1){o?this.nodes=Array.prototype.concat.apply([],t):Array.prototype.push.apply(this.nodes,t),this.node=this.svgNodes.selectAll(".node").data(this.nodes,(t=>t.id));this.appendNodeToGraph(e).merge(this.node),this.node.exit().remove(),this.node=this.svgNodes.selectAll(".node")}appendNodeToGraph(t=!1){const e=this.appendNode();return this.appendRingToNode(e),this.appendOutlineToNode(e),this.appendTextToNode(e),t||this.options.showNodePlate&&this.appendMenuToNode(e),this.formatLabelLegend(),e}appendNode(){const t=this;let e=!1;return this.node.enter().append("g").attr("class",(t=>{let e,o,i="node";if(this.options.highlight)for(o=0;o<this.options.highlight.length;o++)if(e=this.options.highlight[o],Number(t.id)===Number(e.id)){i+=" node-highlighted",i+=e.class||"";break}return i})).each((e=>{const{highlight:o}=t.options;1===o.length&&o.includes(e.id)&&(e.fx=t.svg.node().parentElement.parentElement.clientWidth/2,e.fy=t.svg.node().parentElement.parentElement.clientHeight/2)})).on("click",(function(e,o){const i=o.id;t.fixNodes(o),"属性"!==o.labels[0]?(d3.select(this).classed("selected",!d3.select(this).classed("selected")),d3.select(this).selectAll(".context-menu-item"),d3.selectAll(".context-menu-item").each((function(){d3.select(this).classed("context-show",(function(t){return t.id===i&&!d3.select(this).attr("class").includes("context-show")}))})),"function"==typeof t.options.onNodeClick&&t.options.onNodeClick(e,o,d3),e.stopPropagation()):"iconfont"===o.nodeType&&"function"==typeof t.options.onIconfontClick&&t.options.onIconfontClick(o)})).on("dblclick",((e,o)=>{if(t.fixNodes(o),"function"==typeof t.options.onNodeDoubleClick&&t.options.onNodeDoubleClick(e,o,d3),d3.selectAll(".context-menu-item").each((function(){d3.select(this).classed("context-show",!1)})),!o.properties4show||!o.properties4show.length)return;const i=t.nodes.filter((t=>t.labels.includes("属性")&&t.properties.$_parent_id===o.id));i&&i.length?t.hidePropertiesNodeAndRelationShips(o):t.showPropertiesNodeAndRelationShips(o),"function"==typeof t.options.onMenuNodeClick&&t.options.onMenuNodeClick({name:"AttrLink",status:!!i.length,metaData:o}),e.stopPropagation()})).on("mouseenter",((e,o)=>{"function"==typeof t.options.onNodeMouseEnter&&t.options.onNodeMouseEnter(e,o,d3),e.stopPropagation()})).on("mouseover",((o,i)=>{if("iconfont"!==i.nodeType){const o=i.properties.name;if(e=t.calcTextLine(o,2*t.options.nodeRadius-6)>1,!e)return;t.showToolTips(o)}"function"==typeof t.options.onNodeMouseEnter&&t.options.onNodeMouseover(o,i,d3),o.stopPropagation()})).on("mousemove",(o=>{if(!e)return;const i=`${o.pageX+10}px`,s=o.pageY-10+"px";t.moveToolTips(s,i),o.stopPropagation()})).on("mouseleave",((e,o)=>{"function"==typeof t.options.onNodeMouseLeave&&t.options.onNodeMouseLeave(e,o),e.stopPropagation()})).on("mouseout",((e,o)=>{t.hideToolTips(),"function"==typeof t.options.onNodeMouseOut&&t.options.onNodeMouseOut(e,o,d3),e.stopPropagation()})).call(d3.drag().on("start",this.dragStarted.bind(this)).on("drag",this.dragged.bind(this)).on("end",this.dragEnded.bind(this)))}appendRingToNode(t){return t.append("circle").attr("class","ring").attr("r",1.2*this.options.nodeRadius)}appendOutlineToNode(t){return t.append("circle").attr("class","outline").attr("r",this.options.nodeRadius).style("fill",(t=>this.options.nodeOutlineFillColor?this.options.nodeOutlineFillColor:this.class2color(t.labels[0]))).style("stroke",(t=>this.options.nodeOutlineFillColor?this.class2darkenColor(this.options.nodeOutlineFillColor):this.class2darkenColor(t.labels[0])))}appendTextToNode(t){const e=this;return t.append("text").attr("fill","#ffffff").attr("font-size","10px").attr("pointer-events","none").attr("text-anchor","middle").attr("y","5px").attr("x","0px").each((function(t){if("iconfont"===t.nodeType){const o=`${t.properties.name}`;d3.select(this).attr("class","iconfontKG iconfont-kg-neo4j3d").attr("font-size","20px").attr("y","8px").html((()=>`&#x${e.options.iconMap[o]}`))}else{const o=`${t.properties.name}`;e.wrapEllipsisText(d3.select(this),o,2*e.options.nodeRadius-12)}}))}tickNodes(){this.node&&this.node.attr("transform",(t=>`translate(${t.x}, ${t.y})`))}class2darkenColor(t){return d3.rgb(this.class2color(t)).darker(1)}class2color(t){let e=this.classes2colors[t];return e||(e=this.options.colors[this.numClasses%this.options.colors.length],this.classes2colors[t]=e,this.numClasses++),e}dragStarted(t){this.hideToolTips(),t.active||this.simulation.alphaTarget(.1).restart(),t.subject.fx=t.x,t.subject.fy=t.y,"function"==typeof this.options.onNodeDragStart&&this.options.onNodeDragStart(t)}dragged(t){this.hideToolTips(),this.stickNode(t)}dragEnded(t){t.active||this.simulation.alphaTarget(0),"function"==typeof this.options.onNodeDragEnd&&this.options.onNodeDragEnd(t)}stickNode(t){t.subject.fx=t.x,t.subject.fy=t.y}formatLabelLegend(){this.labelLegend=[];for(const t in this.classes2colors)this.labelLegend.push({label:t,value:this.classes2colors[t]});this.options.onGetLegend&&this.options.onGetLegend(this.labelLegend)}fixNodes(t){t.fx=t.x,t.fy=t.y}}const o=[{title:"RelationLink",value:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><g class="icon"><defs><style>.a{fill:none;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round;stroke-width:1.5px;}</style></defs><title>AttrLink / Collapse</title><circle class="a" cx="13.5" cy="10.498" r="3.75"/><circle class="a" cx="21" cy="2.998" r="2.25"/><circle class="a" cx="21" cy="15.748" r="2.25"/><circle class="a" cx="13.5" cy="20.998" r="2.25"/><circle class="a" cx="3" cy="20.998" r="2.25"/><circle class="a" cx="3.75" cy="5.248" r="2.25"/><line class="a" x1="16.151" y1="7.848" x2="19.411" y2="4.588"/><line class="a" x1="16.794" y1="12.292" x2="19.079" y2="14.577"/><line class="a" x1="13.5" y1="14.248" x2="13.5" y2="18.748"/><line class="a" x1="10.851" y1="13.147" x2="4.59" y2="19.408"/><line class="a" x1="10.001" y1="9.149" x2="5.61" y2="6.514"/></g></svg>'},{title:"AttrLink",value:'<svg viewBox="0 0 24 24" version="1.1" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(-1114.000000, -705.000000)" fill-rule="nonzero"><g id="属性管理" transform="translate(1114.000000, 705.000000)"><rect id="矩形" fill="#ffffff" opacity="0" x="0" y="0" width="32" height="32"></rect><path d="M13.996875,20.1773437 L8.03671875,20.1773437 C8.02734375,20.1773437 8.01796875,20.1773437 8.00859375,20.1796875 L3.86015625,20.1796875 L3.86015625,3.7921875 L20.2476563,3.7921875 L20.2476563,9.4921875 L20.2523438,9.4921875 L20.2523438,13.0640625 C20.2523438,13.4765625 20.5851563,13.809375 20.9976563,13.809375 C21.4101562,13.809375 21.7429688,13.4765625 21.7429688,13.0640625 L21.7429688,6.3609375 C21.7429688,6.33515625 21.740625,6.30703125 21.7382813,6.28125 L21.7382813,3.7921875 C21.7382813,2.971875 21.0703125,2.3015625 20.2476563,2.3015625 L3.86015625,2.3015625 C3.03984375,2.3015625 2.36953125,2.96953125 2.36953125,3.7921875 L2.36953125,20.1796875 C2.36953125,21 3.0375,21.6703125 3.86015625,21.6703125 L10.9148438,21.6703125 L10.9148438,21.6679687 L13.9945313,21.6679687 C14.4070313,21.6679687 14.7398438,21.3351562 14.7398438,20.9226562 C14.7398438,20.5101563 14.4070312,20.1773437 13.996875,20.1773437 Z" id="路径" fill="#ffffff"></path><path d="M6.8578125,7.97578125 L13.771875,7.97578125 C14.184375,7.97578125 14.5171875,7.64296875 14.5171875,7.23046875 C14.5171875,6.81796875 14.184375,6.48515625 13.771875,6.48515625 L6.8578125,6.48515625 C6.4453125,6.48515625 6.1125,6.81796875 6.1125,7.23046875 C6.1125,7.64296875 6.44765625,7.97578125 6.8578125,7.97578125 Z M17.1984375,10.3476562 C17.1984375,9.93515625 16.865625,9.60234375 16.453125,9.60234375 L6.8578125,9.60234375 C6.4453125,9.60234375 6.1125,9.93515625 6.1125,10.3476562 C6.1125,10.7601563 6.4453125,11.0929688 6.8578125,11.0929688 L16.453125,11.0929688 C16.865625,11.0929688 17.1984375,10.7578125 17.1984375,10.3476562 Z" id="形状" fill="#ffffff"></path><path d="M15.8101395,7.96312739 C16.0716241,8.07147026 16.3710471,8.03207195 16.595605,7.85977525 C16.8201628,7.68747854 16.9357347,7.40846327 16.8987805,7.12784474 C16.8618263,6.8472262 16.6779611,6.60764332 16.4164535,6.49935577 C16.1549689,6.39101289 15.8555459,6.43041121 15.6309881,6.60270791 C15.4064302,6.77500461 15.2908583,7.05401989 15.3278125,7.33463842 C15.3647667,7.61525695 15.548632,7.85483984 15.8101395,7.96312739 L15.8101395,7.96312739 Z" id="路径" fill="#ffffff"></path><path d="M19.2445313,16.3335937 C18.80625,16.2164062 18.3492187,16.2773438 17.9554688,16.5023438 C17.1445312,16.9710938 16.865625,18.0117188 17.334375,18.8226563 C17.6484375,19.3664063 18.2203125,19.6710938 18.8085938,19.6710938 C19.096875,19.6710938 19.3898438,19.5984375 19.6570313,19.44375 C19.6734375,19.434375 19.6875,19.425 19.7039063,19.415625 C19.9125,19.284375 19.978125,19.0101563 19.846875,18.7992188 C19.715625,18.590625 19.4414062,18.525 19.2304688,18.65625 C19.2234375,18.6609375 19.2140625,18.665625 19.209375,18.6703125 C18.825,18.8929688 18.3304688,18.759375 18.1101563,18.375 C17.8875,17.990625 18.0210938,17.4960938 18.4054688,17.2757813 C18.590625,17.1679688 18.8085938,17.1398438 19.0171875,17.1960937 C19.2257813,17.2523438 19.3992188,17.3859375 19.5070313,17.5710937 C19.5796875,17.6953125 19.6171875,17.8359375 19.6148438,17.9789063 C19.6125,18.225 19.8117188,18.4265625 20.0578125,18.4289063 L20.0625,18.4289063 C20.3085938,18.4289063 20.5078125,18.2320313 20.5101563,17.9859375 C20.5125,17.6835938 20.4351563,17.3859375 20.2828125,17.1234375 C20.0484375,16.7320313 19.6828125,16.4507813 19.2445313,16.3335938 L19.2445313,16.3335937 Z M6.8578125,12.7195313 C6.4453125,12.7195313 6.1125,13.0523438 6.1125,13.4648438 C6.1125,13.8773437 6.4453125,14.2101562 6.8578125,14.2101562 L13.846875,14.2101562 C14.259375,14.2101562 14.5921875,13.8773437 14.5921875,13.4648438 C14.5921875,13.0523438 14.259375,12.7195313 13.846875,12.7195313 L6.8578125,12.7195313 Z" id="形状" fill="#ffffff"></path></g></g></g></svg>'}];class i{constructor(){this.entityRelationship=[],this.entityExit=[]}appendMenuToNode(t){const e=this;return function(){for(let i=0;i<o.length;i++){const{title:s}=o[i],n=t.append("g").classed("context-menu-item",!0).classed(s,!0).on("click",(function(t,o){if(d3.selectAll(".context-menu-item").each((function(){d3.select(this).classed("context-show",!1)})),d3.select(this).attr("class").includes("AttrLink")){const t=e.nodes.filter((t=>t.labels.includes("属性")&&t.properties.$_parent_id===o.id));t&&t.length?e.hidePropertiesNodeAndRelationShips(o):e.showPropertiesNodeAndRelationShips(o),"function"==typeof e.options.onMenuNodeClick&&e.options.onMenuNodeClick({name:"AttrLink",status:!!t.length,metaData:o})}d3.select(this).attr("class").includes("RelationLink")&&(e.entityExit.includes(o.id)?e.hideEntityNodeAndRelationShips(o):e.showEntityNodeAndRelationShips(o),"function"==typeof e.options.onMenuNodeClick&&e.options.onMenuNodeClick({name:"RelationLink",status:e.entityExit.includes(o.id),metaData:o})),t.stopPropagation()}));n.append("path").attr("fill","rgb(210, 213, 218)").attr("d",(()=>{const t=o.length,s=Math.max(1.3*e.options.nodeRadius,20);return d3.arc()({startAngle:2*Math.PI/t*i,endAngle:2*Math.PI/t*(i+1),innerRadius:s,outerRadius:s+30,padAngle:.05})})),n.append("g").append((()=>{const t=o[i].value;return document.importNode((new DOMParser).parseFromString(t,"application/xml").documentElement.firstChild,!0)})).attr("color","#fff").attr("transform",(()=>{const t=o.length,s=Math.max(1.3*e.options.nodeRadius,20),n=d3.arc().startAngle(2*Math.PI/t*i).endAngle(2*Math.PI/t*(i+1)).innerRadius(s).outerRadius(s+30).padAngle(.05).centroid();return`translate(${n[0]-10}, ${n[1]}) scale(0.7)`}))}}()}showEntityNodeAndRelationShips(t){const{nodes:e,relationships:o}=this.filterShowNodeAndRelationShips(t);this.entityRelationship=this.entityRelationship.concat(o),this.entityExit.push(t.id),this.updateAttrOrEntityNodesAndRelationships(e,this.entityRelationship,!1,!0)}hideEntityNodeAndRelationShips(t){const{nodes:e,relationships:o}=this.filterHideNodeAndRelationShips(t);this.entityRelationship=Array.prototype.concat.apply([],o),this.updateAttrOrEntityNodesAndRelationships(e,this.entityRelationship,!1,!0)}filterShowNodeAndRelationShips(t){const{nodes:e,relationships:o}=this.getOptionsNeo4jData(),i=new Set,s=o.filter((e=>(e.startNode!==t.id&&e.endNode!==t.id||(i.add(e.startNode),i.add(e.endNode)),e.startNode===t.id||e.endNode===t.id))),n=e.filter((t=>i.has(t.id)));return{nodes:e,filterNodes:n,relationships:s}}filterHideNodeAndRelationShips(t){const{nodes:e}=this.getOptionsNeo4jData(),o=new Set;this.relationships.forEach((e=>{e.startNode!==t.id&&e.endNode!==t.id||(o.add(e.startNode),o.add(e.endNode))}));const i=this.relationships.filter((t=>!o.has(t.startNode)&&!o.has(t.endNode)));return this.entityExit=this.entityExit.filter((t=>!o.has(t))),{nodes:e,relationships:i}}getOptionsNeo4jData(){let t=[],e=[];return this.options.neo4jData.results.forEach((o=>{o.data.forEach((o=>{t=t.concat(o.graph.nodes),e=e.concat(o.graph.relationships)}))})),{nodes:t,relationships:e}}hidePropertiesNodeAndRelationShips(t){const e=this.nodes.filter((e=>!e.labels.includes("属性")||e.properties.$_parent_id!==t.id)),o=this.relationships.filter((e=>"属性"!==e.properties.$_custom_relation_properties_union||e.properties.$_parent_id!==t.id));this.updateAttrOrEntityNodesAndRelationships(e,o,!1,!0)}showPropertiesNodeAndRelationShips(t){const{nodes:e,relationShips:o}=this.formatAttrNodesAndRelationShipsData(t);(e||o)&&this.updateAttrOrEntityNodesAndRelationships(e.concat(t),o,!0,!0)}updateAttrOrEntityNodesAndRelationships(t,e,o,i){this.updateRelationships(e,!0),this.updateNodes(t,o,i),this.simulation.nodes(this.nodes),this.simulation.force("link").links(this.relationships)}formatAttrNodesAndRelationShipsData(t){const e=[],o=[],{nodes:i,relationships:s}=this.size();let n=100*i,a=100*s;if(!t.properties4show||!t.properties4show.length)return{};for(const i of t.properties4show)n+=1,a+=1,e.push({id:`${n}`,labels:["属性"],properties:{name:i.value,$_parent_id:t.id},x:t.x,y:t.y,nodeType:i.nodeType,originData:i}),o.push({endNode:`${n}`,id:a,properties:{$_custom_relation_properties_union:"属性",$_parent_id:t.id},startNode:t.id,type:i.key,source:t.id,target:`${n}`,linknum:1});return{nodes:e,relationShips:o}}}class s{constructor(t,e){this.nodeA,this.nodeB,this.relationships=[],t.id<e.id?(this.nodeA=t,this.nodeB=e):(this.nodeA=e,this.nodeB=t)}isLoop(){return this.nodeA===this.nodeB}toString(){return`${this.nodeA.id}:${this.nodeB.id}`}}class n{constructor(t,e,o,i,s,n,a,r){this.deflection=i;const l=t=>t*t,h=this.deflection*Math.PI/180,d={x:Math.cos(h)*t,y:Math.sin(h)*t},p=t/(e+a),c=-o*p/(1-p),u=function(t,e,o,i){const s=t.y/(t.x-c),n=t.y-s*t.x,a=1+l(s),r=2*(s*n-o),h=l(n)+l(o)-l(e),d={x:(-r+i*Math.sqrt(l(r)-4*a*h))/(2*a)};return d.y=(d.x-c)*s,d}(d,e+a,o,-1),f=-d.x/d.y,g=d.y+l(d.x)/d.y,y=-(u.x-o)/u.y,x=(g-(u.y+(u.x-o)*u.x/u.y))/(y-f),m=f*x+g,v=Math.sqrt(l(x-d.x)+l(m-d.y)),L=Math.atan2(d.x-x,m-d.y),N=Math.atan2(u.x-x,m-u.y);let A=N-L;this.deflection>0&&(A=2*Math.PI-A),this.shaftLength=A*v,L>N&&(this.shaftLength=0);let C=(L+N)/2;this.deflection>0&&(C+=Math.PI),this.midShaftPoint={x:x+v*Math.sin(C),y:m-v*Math.cos(C)};const R=function(t){const e=(t<0?1:-1)*Math.sqrt(l(t)/(1+l(f)));return{x:d.x+e,y:d.y+f*e}},k=function(t){const e=(t<0?-1:1)*Math.sqrt(l(t)/(1+l(y))),o=y*e;return{x:u.x+e,y:u.y+o}},M=(t,e)=>({x:x+(v+e)*Math.sin(t),y:m-(v+e)*Math.cos(t)}),w=function(t){const e=(t<0?-1:1)*Math.sqrt(l(t)/(1+l(1/y))),o=e/y;return{x:u.x+e,y:u.y-o}},T=function(t,e){const o=k(t),i=w(e);return{x:o.x+i.x-u.x,y:o.y+i.y-u.y}},b=t=>`${t.x},${t.y}`,D=s/2,S=n/2,j=d.y>0?0:1,E=d.y<0?0:1;this.outline=function(t){if(L>N)return["M",b(k(-S)),"L",b(w(a)),"L",b(k(S)),"Z"].join(" ");if("external"===r){let e=t/v;this.deflection>0&&(e*=-1);const o=C-e/2,i=C+e/2;return["M",b(R(D)),"L",b(R(-D)),"A",v-D,v-D,0,0,j,b(M(o,-D)),"L",b(M(o,D)),"A",v+D,v+D,0,0,E,b(R(D)),"Z","M",b(M(i,D)),"L",b(M(i,-D)),"A",v-D,v-D,0,0,j,b(k(-D)),"L",b(k(-S)),"L",b(w(a)),"L",b(k(S)),"L",b(k(D)),"A",v+D,v+D,0,0,E,b(M(i,D))].join(" ")}return["M",b(R(D)),"L",b(R(-D)),"A",v-D,v-D,0,0,j,b(k(-D)),"L",b(k(-S)),"L",b(w(a)),"L",b(k(S)),"L",b(k(D)),"A",v+D,v+D,0,0,E,b(R(D))].join(" ")},this.overlay=function(t){const e=Math.max(t/2,D);return["M",b(R(e)),"L",b(R(-e)),"A",v-e,v-e,0,0,j,b(k(-e)),"L",b(T(-e,a)),"L",b(T(e,a)),"L",b(k(e)),"A",v+e,v+e,0,0,E,b(R(e))].join(" ")}}}class a{constructor(t,e,o,i,s,n,a){this.length,this.midShaftPoint,this.outline,this.overlay,this.shaftLength,this.deflection=0,this.length=o-(t+e),this.shaftLength=this.length-n;const r=t,l=r+this.shaftLength,h=r+this.length,d=i/2,p=s/2;this.midShaftPoint={x:r+this.shaftLength/2,y:0},this.outline=function(t){if("external"===a){const e=r+(this.shaftLength-t)/2,o=l-(this.shaftLength-t)/2;return["M",r,d,"L",e,d,"L",e,-d,"L",r,-d,"Z","M",o,d,"L",l,d,"L",l,p,"L",h,0,"L",l,-p,"L",l,-d,"L",o,-d,"Z"].join(" ")}return["M",r,d,"L",l,d,"L",l,p,"L",h,0,"L",l,-p,"L",l,-d,"L",r,-d,"Z"].join(" ")},this.overlay=function(t){const e=Math.max(t/2,d);return["M",r,e,"L",h,e,"L",h,-e,"L",r,-e,"Z"].join(" ")}}}class r{constructor(t,e,o,i,s,n,a){this.outline,this.overlay,this.shaftLength,this.midShaftPoint;const r=o*Math.PI/180,l=t,h=t+n,d=t+e,p=d*Math.tan(r/2),c=i/2;function u(t,e){this.x,this.y,this.x=t,this.y=e}this.shaftLength=3*p+i,u.prototype={toString(){return`${this.x} ${this.y}`}};const f=function(t,e,o){const i=e*Math.tan(r/2),s=e/Math.cos(r/2);return new u((i+o)*Math.sin(t),s+(i+o)*Math.cos(t))};this.midShaftPoint=f(0,d,c+a/2+2);const g=(t,e)=>f((Math.PI+r)/2,t,e),y=(t,e)=>f(-(Math.PI+r)/2,t,e);this.outline=function(){const t=p-c,e=p+c;return["M",g(l,c),"L",g(d,c),"A",e,e,0,1,1,y(d,c),"L",y(h,c),"L",y(h,-s/2),"L",y(l,0),"L",y(h,s/2),"L",y(h,-c),"L",y(d,-c),"A",t,t,0,1,0,g(d,-c),"L",g(l,-c),"Z"].join(" ")},this.overlay=function(t){const e=Math.max(t/2,c),o=p-e,i=p+e;return["M",g(l,e),"L",g(d,e),"A",i,i,0,1,1,y(d,e),"L",y(h,e),"L",y(h,-e),"L",y(d,-e),"A",o,o,0,1,0,g(d,-e),"L",g(l,-e),"Z"].join(" ")}}}class l{constructor(){}updateRelationships(t,e=!1){e?this.relationships=Array.prototype.concat.apply([],t):Array.prototype.push.apply(this.relationships,t),this.relationship=this.svgRelationships.selectAll(".relationship").data(this.relationships,(t=>t.id));const o=this.appendRelationshipToGraph();o.relationship.merge(this.relationship),this.relationshipOutline=this.svg.selectAll(".relationship .outline"),o.outline.merge(this.relationshipOutline),this.relationshipOverlay=this.svg.selectAll(".relationship .overlay"),o.overlay.merge(this.relationshipOverlay),this.relationshipText=this.svg.selectAll(".relationship .text"),o.text.merge(this.relationshipText),this.relationship.exit().remove(),this.relationshipOverlay.exit().remove(),this.relationshipOutline.exit().remove(),this.relationshipText.exit().remove(),this.relationships.length?(this.relationship=this.svgRelationships.selectAll(".relationship"),this.relationshipOutline=this.svg.selectAll(".relationship .outline"),this.relationshipOverlay=this.svg.selectAll(".relationship .overlay"),this.relationshipText=this.svg.selectAll(".relationship .text")):(this.relationship=void 0,this.relationshipOutline=void 0,this.relationshipOverlay=void 0,this.relationshipText=void 0)}appendRelationshipToGraph(){const t=this.appendRelationship(),e=this.appendTextToRelationship(t);return{outline:this.appendOutlineToRelationship(t),overlay:this.appendOverlayToRelationship(t),relationship:t,text:e}}appendRelationship(){const t=this;return this.relationship.enter().append("g").attr("class",(e=>{let o,i,s="relationship";if(t.options.highlightRelationShip)for(i=0;i<t.options.highlightRelationShip.length;i++)if(o=t.options.highlightRelationShip[i],Number(e.id)===Number(o.id)){s+=" relationship-highlighted",s+=o.class||"";break}return s})).on("click",(function(t){d3.select(this).selectAll(".text").classed("active_text",!0),t.stopPropagation()})).on("dblclick",((e,o)=>{"function"==typeof t.options.onRelationshipDoubleClick&&t.options.onRelationshipDoubleClick(o),e.stopPropagation()})).on("mouseenter",(()=>{}))}appendTextToRelationship(t){return t.append("text").attr("class","text").attr("fill","#000000").attr("font-size","8px").attr("pointer-events","none").attr("text-anchor","middle").text((t=>t.type))}appendOutlineToRelationship(t){return t.append("path").attr("class","outline").attr("fill","#a5abb6").attr("stroke","none")}appendOverlayToRelationship(t){return t.append("path").attr("class","overlay")}tickRelationships(){this.layoutRelationships(),this.relationship&&(this.layoutRelationships(),this.relationship.attr("transform",(t=>`translate(${t.source.x} ${t.source.y}) rotate(${t.naturalAngle+180})`)),this.tickRelationshipsTexts(),this.tickRelationshipsOutlines(),this.tickRelationshipsOverlays())}tickRelationshipsTexts(){this.relationshipText.attr("transform",(t=>t.naturalAngle<90||t.naturalAngle>270?`rotate(180 ${t.arrow.midShaftPoint.x} ${t.arrow.midShaftPoint.y})`:null)),this.relationshipText.attr("x",(t=>t.arrow.midShaftPoint.x)),this.relationshipText.attr("y",(t=>t.arrow.midShaftPoint.y+parseFloat(8.5)/2-1))}tickRelationshipsOutlines(){this.relationship.each((function(t){const e=d3.select(this),o=e.select(".outline"),i=e.select(".text").node().getComputedTextLength();let s=i>0?i+8:0;o.attr("d",(t=>(s>t.arrow.shaftLength&&(s=t.arrow.shaftLength),t.arrow.outline(s))))}))}tickRelationshipsOverlays(){this.relationshipOverlay.attr("d",(t=>t.arrow.overlay(this.options.arrowSize)))}layoutRelationships(){const t=this.groupedRelationships();return this.computeGeometryForNonLoopArrows(t),this.distributeAnglesForLoopArrows(t,this.relationships),(()=>{const e=[];for(const o of Array.from(t)){for(const t of Array.from(o.relationships))delete t.arrow;const t=(o.relationships.length-1)/2,i=30,s=150,l=o.relationships.length-1,h=i*l>s?s/l:i;e.push((()=>{for(let e=0;e<o.relationships.length;e++){const s=o.relationships[e],{nodeRadius:l}=this.options,d=this.options.relationshipWidth,p=this.options.arrowSize,c=p;if(o.isLoop())s.arrow=new r(l,40,i,d,p,c,s.captionHeight||11);else if(e===t)s.arrow=new a(l,l,s.centreDistance,d,p,c,s.captionLayout||"external");else{let i=h*(e-t);o.nodeA!==s.source&&(i*=-1),s.arrow=new n(l,l,s.centreDistance,i,d,p,c,s.captionLayout||"external")}}})())}return e})()}groupedRelationships(){const t={};for(const e of Array.from(this.relationships)){let o=new s(e.source,e.target);o=null!=t[o]?t[o]:o,o.relationships.push(e),t[o]=o}return(()=>{const e=[];for(const o in t){const i=t[o];e.push(i)}return e})()}computeGeometryForNonLoopArrows(t){const e=t=>t*t;return(()=>{const o=[];for(const i of Array.from(t))if(i.isLoop())o.push(void 0);else{const t=i.nodeA.x-i.nodeB.x,s=i.nodeA.y-i.nodeB.y,n=(Math.atan2(s,t)/Math.PI*180+360)%360,a=Math.sqrt(e(t)+e(s));o.push((()=>{const t=[];for(const e of Array.from(i.relationships))e.naturalAngle=e.target===i.nodeA?(n+180)%360:n,t.push(e.centreDistance=a);return t})())}return o})()}distributeAnglesForLoopArrows(t,e){return(()=>{const o=[];for(const i of Array.from(t))if(i.isLoop()){let t,s,n=[];const a=i.nodeA;for(const t of Array.from(e))t.isLoop()||(t.source===a&&n.push(t.naturalAngle),t.target===a&&n.push(t.naturalAngle+180));if(n=n.map((t=>(t+360)%360)).sort(((t,e)=>t-e)),n.length>0){let e,a;const r={start:0,end:0};for(t=0;t<n.length;t++){a=n[t],e=t===n.length-1?n[0]+360:n[t+1],e-a>r.end-r.start&&(r.start=a,r.end=e)}s=(r.end-r.start)/(i.relationships.length+1),o.push((()=>{const e=[];for(t=0;t<i.relationships.length;t++){const o=i.relationships[t];e.push(o.naturalAngle=(r.start+(t+1)*s-90)%360)}return e})())}else s=360/i.relationships.length,o.push((()=>{const e=[];for(t=0;t<i.relationships.length;t++){const o=i.relationships[t];e.push(o.naturalAngle=t*s)}return e})())}else o.push(void 0);return o})()}}class h{constructor(){}wrapEllipsisText(t,e,o,i,s="em"){const n=e?e.split("").reverse():[];let a;const r=[];let l=0;const h=[];for(;a=n.pop();){r.push(a);const t=r.join(" ");if(this.measureWidth()(t)>o&&(r.pop(),l+=1),h.push(a),3===l){h.splice(-1,2,"...");break}}const d=h.join("");this.wrapText(t,d,o,i,s,l)}calcTextLine(t,e){const o=t?t.split("").reverse():[];let i;const s=[];let n=0;for(;i=o.pop();){s.push(i);const t=s.join(" ");this.measureWidth()(t)>e&&(s.pop(),n+=1)}return n}wrapText(t,e,o,i,s="em",n){const a=e.split("").reverse();let r,l=[],h=0;const d=t.attr("x"),p=n>1?"0px":t.attr("y");i||(i=1.1),t.text(null);let c=t.append("tspan").attr("x",d).attr("y",p).attr("dy",0);for(;r=a.pop();)l.push(r),c.text(l.join("")),this.measureWidth()(c.text())>o&&(l.pop(),c.text(l.join(" ")),l=[r],c=t.append("tspan").attr("x",d).attr("y",p).attr("dy",`${++h*i}${s}`).text(r))}measureWidth(){const t=document.createElement("canvas").getContext("2d");return e=>t.measureText(e).width}}class d{constructor(){this.tooltips=d3.select("body").append("div").attr("class","svg-tooltip").attr("id","svg-tooltip").style("visibility","hidden").style("color","#fff").style("display","block").style("font-size","11px").style("max-width","320px").style("padding",".2rem .4rem").style("position","absolute").style("text-overflow","ellipsis").style("word-wrap","break-word").style("line-height","15px").style("z-index",300).style("background","rgba(69, 77, 93, .9)").style("border-radius",".1rem").style("left","0px").style("top","0px")}showToolTips(t){this.tooltips.style("visibility","visible").text(t)}moveToolTips(t,e){this.tooltips.style("top",t).style("left",e)}hideToolTips(){this.tooltips.style("visibility","hidden")}destroyToolsTips(){d3.select("#svg-tooltip").remove()}}class p extends(function(...e){class o{constructor(){for(const o of e)t(this,new o)}}for(const i of e)t(o,i),t(o.prototype,i.prototype);return o}(e,i,l,h,d)){constructor(t,e){super(),this.options={showNodePlate:!0,arrowSize:4,colors:["#68bdf6","#6dce9e","#faafc2","#f2baf6","#ff928c","#fcea7e","#ffc766","#405f9e","#a5abb6","#78cecb","#b88cbb","#ced2d9","#e84646","#fa5f86","#ffab1a","#fcda19","#797b80","#c9d96f","#47991f","#70edee","#ff75ea"],highlight:void 0,highlightRelationShip:void 0,neo4jData:void 0,neo4jDataUrl:void 0,nodeOutlineFillColor:void 0,nodeRadius:25,relationshipWidth:1.5,relationshipColor:"#a5abb6",zoomFit:!1,minCollision:60,iconMap:void 0,onNodeClick:void 0,onNodeDoubleClick:void 0,onNodeDragEnd:void 0,onNodeDragStart:void 0,onNodeMouseEnter:void 0,onNodeMouseover:void 0,onNodeMouseLeave:void 0,onNodeMouseOut:void 0,onRelationshipDoubleClick:void 0,onMenuNodeClick:void 0,onIconfontClick:void 0,onGetLegend:void 0},this.nodes=[],this.relationships=[],this.labelLegend=[],this.container=void 0,this.svg=void 0,this.svgRelationships=void 0,this.svgNodes=void 0,this.imulation=void 0,this.node=void 0,this.relationship=void 0,this.relationshipOutline=void 0,this.relationshipOverlay=void 0,this.relationshipText=void 0,this.classes2colors={},this.numClasses=0,this.info=void 0,this.justLoaded=!1,this.svgScale=void 0,this.svgTranslate=void 0,this.init(t,e)}init(t,e){var o,i;this.options.minCollision||(this.options.minCollision=2*this.options.nodeRadius),o=this.options,i=e,Object.keys(i).forEach((t=>{o[t]=i[t]})),this.initContainer(t),this.appendGraph(),this.simulation=this.initSimulation(),this.options.neo4jData?this.loadNeo4jData(this.options.neo4jData):this.options.neo4jDataUrl?this.loadNeo4jDataFromUrl(this.options.neo4jDataUrl):console.error("Error: both neo4jData and neo4jDataUrl are empty!")}initContainer(t){this.container=d3.select(t),this.container.attr("class","neo4jd3").html("")}appendGraph(){const t=this;this.svg=this.container.append("svg").attr("width","100%").attr("height","100%").attr("class","neo4jd3-graph").call(d3.zoom().on("zoom",(e=>{let o=e.transform.k;const i=[e.transform.x,e.transform.y];t.svgTranslate&&(i[0]+=t.svgTranslate[0],i[1]+=t.svgTranslate[1]),t.svgScale&&(o*=t.svgScale),t.svg.attr("transform",`translate(${i[0]}, ${i[1]}) scale(${o})`)}))).on("click",(t=>{d3.selectAll(".relationship .text").classed("active_text",!1),d3.selectAll(".context-menu-item").each((function(){d3.select(this).classed("context-show",!1)})),t.stopPropagation()})).on("dblclick.zoom",null).append("g").attr("width","100%").attr("height","100%"),this.svgRelationships=this.svg.append("g").attr("class","relationships"),this.svgNodes=this.svg.append("g").attr("class","nodes")}initSimulation(){return d3.forceSimulation().force("collide",d3.forceCollide().radius((()=>this.options.minCollision)).iterations(2)).force("charge",d3.forceManyBody()).force("link",d3.forceLink().id((t=>t.id))).force("center",d3.forceCenter(this.svg.node().parentElement.parentElement.clientWidth/2,this.svg.node().parentElement.parentElement.clientHeight/2)).on("tick",(()=>{this.tick()})).on("end",(()=>{this.options.zoomFit&&!this.justLoaded&&(this.justLoaded=!0,this.zoomFit(2))}))}loadNeo4jData(){this.nodes=[],this.relationships=[],this.updateWithNeo4jData(this.options.neo4jData)}loadNeo4jDataFromUrl(t){const e=this;this.nodes=[],this.relationships=[],d3.json(t,((t,o)=>{if(t)throw t;e.updateWithNeo4jData(o)}))}updateWithNeo4jData(t){const e=this.neo4jDataToD3Data(t);this.updateWithD3Data(e)}updateWithD3Data(t){this.updateNodesAndRelationships(t.nodes,t.relationships)}updateGraphWithD3Data(t){const{nodes:e,relationships:o}=this.neo4jDataToD3Data(t);this.updateRelationships(o,!0),this.updateNodes(e,!1,!0),this.simulation.nodes(this.nodes),this.simulation.force("link").links(this.relationships)}updateNodesAndRelationships(t,e){this.updateRelationships(e),this.updateNodes(t),this.simulation.nodes(this.nodes),this.simulation.force("link").links(this.relationships)}neo4jDataToD3Data(t){const e={nodes:[],relationships:[]};return t.results.forEach((t=>{t.data.forEach((t=>{t.graph.nodes.forEach((t=>{var o,i;o=e.nodes,i=t.id,o.filter((t=>t.id===i)).length>0||e.nodes.push(t)})),t.graph.relationships.forEach((t=>{t.source=t.startNode,t.target=t.endNode,t.naturalAngle=0,t.isLoop=function(){return this.source===this.target},e.relationships.push(t)})),t.graph.relationships.sort(((t,e)=>t.source>e.source?1:t.source<e.source?-1:t.target>e.target?1:t.target<e.target?-1:0))}))})),e}tick(){this.tickNodes(),this.tickRelationships()}zoomFit(){const t=this.svg.node().getBBox(),e=this.svg.node().parentElement.parentElement,o=e.clientWidth,i=e.clientHeight,{width:s}=t,{height:n}=t,a=t.x+s/2,r=t.y+n/2;0!==s&&0!==n&&(this.svgScale=.85/Math.max(s/o,n/i),this.svgTranslate=[o/2-this.svgScale*a,i/2-this.svgScale*r],this.svg.attr("transform",`translate(${this.svgTranslate[0]}, ${this.svgTranslate[1]}) scale(${this.svgScale})`))}size(){return{nodes:this.nodes.length,relationships:this.relationships.length}}}return p}));
